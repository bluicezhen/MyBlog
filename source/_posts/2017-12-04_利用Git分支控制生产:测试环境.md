---
title: 利用Git分支控制生产/测试环境
date: 2017-12-04 21:00:00
categories: 编程之道
tags: Python, Git, 环境
summary: 要说我在软件开发中学到了什么，我的答案是抉择与取舍。抉择与取舍，这就是我的实训心得。感觉这和我二十岁时，得到的我活了这二十年的心得一样——我们不能总是随心所欲。
---

如何区分开发测试环境是开发中的一很重要的事情。一般一个线上项目都至少有两个环境（开发环境、生产环境），甚至更多。本文以Python为例，讲讲我在环境控制上遇到的那些坑。

**我一开始是使用文件来区分环境的。**

```
app/
    - main.py
    - env.py
    - ...
```

其中`env.py`只有一行，表明环境类型。

```python
env = "dev"
```

在其他文件中，可以通过`import env.env`来判断使当前环境。

但这样有一个问题，就是在不同环境中，要确保正确的修改了`env.py`。我们生产服务器有一次更新代码的时候，因为之前有人临时在服务器上修改了代码，使用了`git reset --hard`命令， 导致了`env.py`被重置。整个网站看上去正常，但没有用户能登录上去，因为使用了测试服务器的配置。

利用Git分支控制环境是一种更安全的方法。基本上就是即当前项目在`master`分支即为正式环境，如果不是则为`dev`环境（当然也可以不止这些）。隐藏的文件`.git/HEAD`一般是这样的：

```
ref: refs/heads/master

```

其中，`master`代表目前项目运行在`master`分支。这样我们可以修改env.py的代码:

```python 
env = "dev"
with open(".git/HEAD", "rt") as f:
    git_head = f.read().split("\n")[0].split("/")[-1]
if git_head == "master":
        env = "pro"
```